<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>Web Workers example</title>
    <style>
      body {
        margin: 5px;
      }
      .half {
        width: 50%;
        float: left;
      }
      #pic {
        max-width: 300px;
        max-height: 300px;
        width: 40vw;
        height: 40vw;
      }
      .box {
        display: inline-block;
        border: solid 1px black;  
        margin: 10px;
        height: 30px;
        padding: 5px;
        background-color: #DDD;
      }
      #image {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="half" id="animation">
      <script>
        var canvas, context;

        init();
        setInterval(animate, 16);

        function init() {
          canvas = document.createElement( 'canvas' );
          canvas.width = 400;
          canvas.height = 300;
          context = canvas.getContext( '2d' );
          document.querySelector('#animation').appendChild( canvas );
        }

        function animate() {
          drawTime();
        }

        var lastTime;

        function drawTime() {
          var days = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday"
          ]

          var months = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
          ]


          var now = new Date(Date.now());

          var year = now.getYear();
          var month = now.getMonth();
          var date = now.getDate();
          var day = now.getDay();
          var hours = now.getHours();
          var mins = now.getMinutes();
          var secs = now.getSeconds();
          var ms = now.getMilliseconds();

          var dateString = days[day] + ", " + date + " " + months[month] + " " + parseInt(1900 + year);

          var timeString = hours + ":" + mins + ":" + secs + ":" + ms;

          var frameTimeDiff = now - lastTime;

          context.font = "36px serif";

          if (frameTimeDiff > 50) {
            context.clearRect(0,0, canvas.width, canvas.height);
            context.fillText("Jank spotted: " + frameTimeDiff + "ms", 20, 50);
          } else {
            context.clearRect(20,60,canvas.width, canvas.height);
          }

          context.fillText(dateString, 20, 100);
          context.fillText(timeString, 20, 150);

          lastTime = now;
        };
      </script>
    </div>
    <div class="half" id="image-manipulator">
      <input type="file" id="imageLoader" name="imageLoader"/>
      <button id="invert">Invert</button>
      <button id="chroma">Chroma</button>
      <button id="greyscale">Greyscale</button>
      <button id="vibrant">Vibrant</button>
      <button id="revert">Revert to Original</button>
      <canvas id="image"></canvas>
    </div>
    <script>
      // Generated by CoffeeScript 1.9.1
      // forked from github.com/jwill/psychic-lana
      // with help from http://stackoverflow.com/questions/10906734/how-to-upload-image-into-html5-canvas

      var original;
      var imageLoader = document.querySelector('#imageLoader');
      imageLoader.addEventListener('change', handleImage, false);
      var canvas = document.querySelector('#image');
      var ctx = canvas.getContext('2d');

      var imageWorker = new Worker('scripts/worker-improved.js');

      function handleImage(e){
        var reader = new FileReader();
        reader.onload = function(event){
          var img = new Image();
          img.onload = function(){
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img,0,0);
            original = ctx.getImageData(0, 0, canvas.width, canvas.height);
          }
          img.src = event.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
      }

      function toggleButtonsAbledness() {
        var buttons = document.querySelectorAll('button');
        for (var i = 0; i < buttons.length; i++) {
          if (buttons[i].hasAttribute('disabled')) {
            buttons[i].removeAttribute('disabled')
          } else {
            buttons[i].setAttribute('disabled', null);
          }
        };
      }

      function manipulateImage(type) {
        var a, b, g, i, imageData, j, length, pixel, r, ref;
        imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        toggleButtonsAbledness();
        imageWorker.postMessage({"imageData": imageData, "type": type});

        imageWorker.onmessage = function(e) {
          toggleButtonsAbledness();
          var image = e.data;
          if (image) return ctx.putImageData(e.data, 0, 0);
          console.log("No manipulated image returned.")
        }

        imageWorker.onerror = function(error) {
          function WorkerException(message) {
            this.name = "WorkerException";
            this.message = message;
          };
          throw new WorkerException('Worker error.');
        };
      };

      function revertImage() {
        return ctx.putImageData(original, 0, 0);
      }

      document.querySelector('#invert').onclick = function() {
        manipulateImage("invert");
      };
      document.querySelector('#chroma').onclick = function() {
        manipulateImage("chroma");
      };
      document.querySelector('#greyscale').onclick = function() {
        manipulateImage("greyscale");
      };
      document.querySelector('#vibrant').onclick = function() {
        manipulateImage("vibrant");
      };
      document.querySelector('#revert').onclick = function() {
        revertImage();
      };
    </script>
  </body>
</html>